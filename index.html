<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Documentos - ADELACT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        @media print {
            body * { visibility: hidden; }
            .factura-preview, .factura-preview * { visibility: visible; }
            .factura-preview { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            @page { margin: 0.5cm; }
        }
        .icon { width: 20px; height: 20px; display: inline-block; vertical-align: middle; }
        .icon-lg { width: 32px; height: 32px; }
        .icon-xl { width: 64px; height: 64px; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-green-50 min-h-screen">
    <div class="p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-blue-100 no-print">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="bg-blue-600 p-2 rounded-lg">
                            <svg class="icon-lg text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800">ADELACT</h1>
                    </div>

                    <div class="mb-4">
                        <label class="text-sm font-semibold text-gray-700 mb-2 block">Tipo de Documento</label>
                        <select id="tipoDocumento" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none bg-white">
                            <option value="FACTURA">FACTURA</option>
                            <option value="COTIZACION">COTIZACIÓN</option>
                        </select>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">No. Documento</label>
                                <input type="text" id="numeroFactura" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none" placeholder="F-001 / C-001" />
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">Fecha</label>
                                <input type="date" id="fecha" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none" />
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-2 block">Socio que Atiende</label>
                            <input type="text" id="socioAtiende" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none" placeholder="Nombre del socio" />
                        </div>

                        <div>
                            <label class="text-sm font-semibold text-gray-700 mb-2 block">Nombre del Cliente</label>
                            <input type="text" id="cliente" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none" placeholder="Nombre completo" />
                        </div>
                    </div>

                    <div class="border-t-2 border-gray-100 pt-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Agregar Productos</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">
                                    Producto
                                </label>
                                <select
                                    id="selectProducto"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition bg-white"
                                >
                                    <option value="">Seleccionar producto...</option>
                                    <option value="Queso Oreado">Queso Oreado</option>
                                    <option value="Queso Fresco">Queso Fresco</option>
                                    <option value="Queso con Chile">Queso con Chile</option>
                                    <option value="Mantequilla Pura">Mantequilla Pura</option>
                                    <option value="Mantequilla Simple">Mantequilla Simple</option>
                                    <option value="Quesillo">Quesillo</option>
                                    <option value="Cuajada">Cuajada</option>
                                    <option value="otro">➕ Otro producto...</option>
                                </select>
                            </div>

                            <div id="campoNombreProducto" style="display: none;">
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">
                                    Nombre del Producto
                                </label>
                                <input
                                    type="text"
                                    id="nombreProducto"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition"
                                    placeholder="Nombre del producto"
                                />
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-semibold text-gray-700 mb-2 block">
                                        Precio Unitario (L)
                                    </label>
                                    <input
                                        type="number"
                                        id="precioUnitario"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition"
                                        placeholder="0.00"
                                        min="0"
                                        step="0.01"
                                        value="0"
                                    />
                                </div>

                                <div>
                                    <label class="text-sm font-semibold text-gray-700 mb-2 block">
                                        Cantidad
                                    </label>
                                    <input
                                        type="number"
                                        id="cantidad"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none transition"
                                        min="1"
                                        value="1"
                                    />
                                </div>
                            </div>

                            <button
                                onclick="agregarProducto()"
                                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition flex items-center justify-center gap-2 shadow-lg"
                            >
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Agregar Producto
                            </button>
                        </div>
                    </div>

                    <div id="listaProductos" class="mt-6 border-t-2 border-gray-100 pt-6" style="display: none;">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Productos Agregados</h3>
                        <div id="productosAgregados" class="space-y-2"></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border-2 border-gray-200">
                    <div id="facturaPreview" class="factura-preview">
                        <div class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-8">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-3">
                                    <svg class="icon-lg text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-9 4h9m-9 4h9M7 7h.01M7 11h.01M7 15h.01"/>
                                    </svg>
                                    <div>
                                        <h2 class="text-4xl font-black mb-1">ADELACT</h2>
                                        <p class="text-blue-100 tracking-wide uppercase text-sm">Productos Lácteos</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-blue-100 mb-1 font-bold" id="labelTipoDoc">FACTURA No.</p>
                                    <p id="displayNumeroFactura" class="text-3xl font-mono font-bold text-yellow-300">---</p>
                                </div>
                            </div>
                            <p class="text-xs text-blue-200 mt-2">Choluteca, Honduras. ¡Gracias por su preferencia!</p>
                        </div>

                        <div class="p-8 bg-white border-b border-gray-100">
                            <div class="grid grid-cols-2 gap-8">
                                <div>
                                    <div class="mb-4">
                                        <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Atendido por:</p>
                                        <p id="displaySocio" class="text-lg font-semibold text-gray-700 capitalize">Sin asignar</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Cliente:</p>
                                        <p id="displayCliente" class="text-xl font-bold text-gray-800 capitalize">Sin especificar</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-bold text-gray-400 uppercase tracking-tighter">Fecha de Emisión:</p>
                                    <p id="displayFecha" class="text-lg font-bold text-gray-800">---</p>
                                    <p class="text-xs text-gray-500">Hora: <span id="displayHora">--:--</span> (GMT-6)</p>
                                </div>
                            </div>
                        </div>

                        <div class="px-8 py-6">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-blue-900">
                                        <th class="text-left py-3 text-xs font-black text-blue-900 uppercase">Descripción</th>
                                        <th class="text-center py-3 text-xs font-black text-blue-900 uppercase">Cant.</th>
                                        <th class="text-right py-3 text-xs font-black text-blue-900 uppercase">Precio Unit.</th>
                                        <th class="text-right py-3 text-xs font-black text-blue-900 uppercase">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductos">
                                    <tr>
                                        <td colspan="4" class="text-center py-12 text-gray-400">
                                            <svg class="icon-xl mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                            </svg>
                                            <p class="text-lg">No hay productos agregados</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="mt-8 border-t-2 border-gray-100 pt-6">
                                <div class="flex justify-end items-center gap-6">
                                    <span class="text-xl font-bold text-gray-500">TOTAL A PAGAR:</span>
                                    <span id="totalFactura" class="text-4xl font-black text-blue-700">L 0.00</span>
                                </div>
                            </div>

                            <div class="mt-12 text-center">
                                <div class="inline-block border-t border-gray-300 px-8 pt-2">
                                    <p class="text-xs text-gray-400 uppercase font-bold">Firma de Recibido</p>
                                </div>
                                <p class="mt-6 text-sm text-gray-500 italic">"Calidad que se siente en cada bocado"</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-gray-100 border-t-2 border-gray-200 no-print space-y-3">
                        <button
                            onclick="descargarComoImagen()"
                            class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-4 px-6 rounded-xl font-bold hover:from-purple-700 hover:to-purple-800 transition flex items-center justify-center gap-3 shadow-lg text-lg"
                        >
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Descargar como Imagen (PNG)
                        </button>
                        
                        <button
                            onclick="limpiarFactura()"
                            class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-red-600 hover:to-red-700 transition flex items-center justify-center gap-2 shadow-md"
                        >
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Limpiar Formulario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let productos = [];
        
        function establecerFechaYHoraLocal() {
            const now = new Date();
            const offset = now.getTimezoneOffset();
            const localDate = new Date(now.getTime() - (offset * 60 * 1000));
            document.getElementById('fecha').value = localDate.toISOString().split('T')[0];
            
            actualizarDisplayFechaYHora();
        }

        function actualizarDisplayFechaYHora() {
            const fechaVal = document.getElementById('fecha').value;
            if (fechaVal) {
                const optionsDate = { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Tegucigalpa' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'America/Tegucigalpa' };

                const dateToFormat = new Date(fechaVal);
                
                document.getElementById('displayFecha').textContent = 
                    new Intl.DateTimeFormat('es-HN', optionsDate).format(dateToFormat);
                
                const nowTegucigalpa = new Date().toLocaleString('en-US', { timeZone: 'America/Tegucigalpa' });
                const horaTegucigalpa = new Date(nowTegucigalpa).toLocaleTimeString('es-HN', { hour: '2-digit', minute: '2-digit', hour12: false });
                document.getElementById('displayHora').textContent = horaTegucigalpa;

            }
        }

        establecerFechaYHoraLocal();

        document.getElementById('numeroFactura').addEventListener('input', e => {
            document.getElementById('displayNumeroFactura').textContent = e.target.value || '---';
        });

        document.getElementById('socioAtiende').addEventListener('input', e => {
            document.getElementById('displaySocio').textContent = e.target.value || 'Sin asignar';
        });

        document.getElementById('cliente').addEventListener('input', e => {
            document.getElementById('displayCliente').textContent = e.target.value || 'Sin especificar';
        });

        document.getElementById('fecha').addEventListener('change', actualizarDisplayFechaYHora);

        document.getElementById('tipoDocumento').addEventListener('change', e => {
            const tipo = e.target.value;
            const label = document.getElementById('labelTipoDoc');
            document.getElementById('displayTipoDocumento').textContent = tipo;
            label.textContent = tipo + ' No.';
        });

        document.getElementById('selectProducto').addEventListener('change', function() {
            const campoNombre = document.getElementById('campoNombreProducto');
            const nombreInput = document.getElementById('nombreProducto');
            if (this.value === 'otro') {
                campoNombre.style.display = 'block';
                nombreInput.value = '';
                nombreInput.focus();
            } else {
                campoNombre.style.display = 'none';
                nombreInput.value = this.value; 
            }
            document.getElementById('precioUnitario').value = '0'; 
            document.getElementById('cantidad').value = '1'; 
            document.getElementById('precioUnitario').focus();
        });

        function agregarProducto() {
            const select = document.getElementById('selectProducto');
            const nombre = select.value === 'otro' ? document.getElementById('nombreProducto').value.trim() : select.value.trim();
            const precio = parseFloat(document.getElementById('precioUnitario').value);
            const cantidad = parseInt(document.getElementById('cantidad').value);

            if (!nombre || nombre === "" || isNaN(precio) || precio <= 0 || isNaN(cantidad) || cantidad <= 0) {
                alert('Por favor, complete los datos del producto (nombre, precio unitario, cantidad) correctamente.');
                return;
            }

            productos.push({ id: Date.now(), nombre, precio, cantidad, subtotal: precio * cantidad });
            actualizarUI();
            
            select.value = "";
            document.getElementById('nombreProducto').value = '';
            document.getElementById('campoNombreProducto').style.display = 'none';
            document.getElementById('precioUnitario').value = "0";
            document.getElementById('cantidad').value = "1";
            select.focus();
        }

        function actualizarUI() {
            const contenedor = document.getElementById('productosAgregados');
            const tabla = document.getElementById('tablaProductos');
            const listaDiv = document.getElementById('listaProductos');

            listaDiv.style.display = productos.length > 0 ? 'block' : 'none';

            contenedor.innerHTML = productos.map(p => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span class="text-sm font-semibold text-gray-800">${p.nombre} (${p.cantidad} x L${p.precio.toFixed(2)})</span>
                    <button onclick="eliminarProducto(${p.id})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `).join('');

            if (productos.length === 0) {
                tabla.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-12 text-gray-400">
                            <svg class="icon-xl mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <p class="text-lg">No hay productos agregados</p>
                        </td>
                    </tr>
                `;
            } else {
                tabla.innerHTML = productos.map((p, index) => `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} border-b border-gray-100">
                        <td class="py-3 px-2 font-medium text-gray-800">${p.nombre}</td>
                        <td class="py-3 px-2 text-center text-gray-700">${p.cantidad}</td>
                        <td class="py-3 px-2 text-right text-gray-700">L ${p.precio.toFixed(2)}</td>
                        <td class="py-3 px-2 text-right font-semibold text-gray-800">L ${p.subtotal.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
            
            const total = productos.reduce((sum, p) => sum + p.subtotal, 0);
            document.getElementById('totalFactura').textContent = `L ${total.toFixed(2)}`;
        }

        function eliminarProducto(id) {
            productos = productos.filter(p => p.id !== id);
            actualizarUI();
        }

        async function descargarComoImagen() {
            const facturaElement = document.getElementById('facturaPreview');
            
            try {
                const botonOriginal = event.target.closest('button');
                const textoOriginal = botonOriginal.innerHTML;
                botonOriginal.innerHTML = `
                    <svg class="icon animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Generando...
                `;
                botonOriginal.disabled = true;

                const canvas = await html2canvas(facturaElement, {
                    scale: 2, 
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true 
                });

                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const tipoDoc = document.getElementById('tipoDocumento').value.toLowerCase();
                    const numeroDoc = document.getElementById('numeroFactura').value || 'sin-numero';
                    link.href = url;
                    link.download = `${tipoDoc}-${numeroDoc}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    botonOriginal.innerHTML = textoOriginal;
                    botonOriginal.disabled = false;
                }, 'image/png');

            } catch (error) {
                console.error('Error al generar imagen:', error);
                alert('Hubo un error al generar la imagen. Por favor intenta de nuevo.');
                
                const botonOriginal = event.target.closest('button');
                botonOriginal.innerHTML = textoOriginal;
                botonOriginal.disabled = false;
            }
        }

        function limpiarFactura() {
            if (productos.length > 0 && !confirm('¿Estás seguro de que quieres limpiar todos los datos?')) {
                return;
            }

            document.getElementById('numeroFactura').value = '';
            document.getElementById('socioAtiende').value = '';
            document.getElementById('cliente').value = '';
            document.getElementById('tipoDocumento').value = 'FACTURA'; 
            establecerFechaYHoraLocal();
            productos = [];
            
            document.getElementById('displayNumeroFactura').textContent = '---';
            document.getElementById('displaySocio').textContent = 'Sin asignar';
            document.getElementById('displayCliente').textContent = 'Sin especificar';
            document.getElementById('labelTipoDoc').textContent = 'FACTURA No.';
            actualizarUI();
        }

        actualizarUI();
        document.getElementById('tipoDocumento').dispatchEvent(new Event('change')); 
    </script>
</body>
</html>
